---
title: "Infrastructure: Replacing a Dead RAID 5 Drive in QNAP NAS"
date: 2010-10-30
lastmod: 2010-10-30
draft: false
thumbnail: "/coding-gallery"
series: ["devops"]
authors: ["martincjarvis"]
---
<p>It’s been a while since I last posted – it’s been crazy busy at work – and this is a completely non-.Net related post (<strong><em>sorry</em></strong>).&nbsp; However, like many of you (I’m&nbsp; sure) I’ve got a personal SVN repository (where I keep my .Net code, so there is a tenuous link!) which is hosted on my QNAP 419P NAS Drive on a RAID5 volume across 4 Hot Swappable Disks.&nbsp; </p>  <p>For the non-technical, this is a little whizzy box with tonnes of space and can withstand a single complete hard disk failure without loosing data.&nbsp; </p>  <p>Recently one of the disk drives failed in the volume (completely dead) and whilst my data’s intact and everything carried on as best as it could, I needed to replace the drive.&nbsp; I was completely under the impression that this operation went along the lines of:</p>  <ol>   <li>Remove Dead Drive </li>    <li>Insert New Disk </li>    <li>Click ‘Repair’ on RAID volume in config </li>    <li>Wait for repair to complete </li>    <li>PROFIT!! </li> </ol>  <p>And with most corporate RAID solutions that’s exactly what happens.&nbsp; However, after completing Step 2 of my plan I discovered that the QNAP didn’t recognise the new disk at all and the Repair button was greyed out.</p>  <p>WTF?!?</p>  <p>Well, it turns out the QNAP’s software raid manager can’t automatically recover from actual dead disks, only disks incorrectly flagged as faulty.&nbsp; Genius.</p>  <p>After a bit of Googling, I found that ‘all’ I needed to do was duplicate the partition table from one of the remaining live disks to the new disk and hopefully the low-level raid manager will them automatically rebuild the array.</p>  <p>So the actual steps are:</p>  <ol>   <li>Replace disk with new one </li>    <li>SSH into QNAP box with Administrator priveleges </li>    <li>Get the partition settings from fdisk (type: <strong><em><font face="Courier New">fdisk –l</font></em></strong>) </li>    <li>Identify a live disk in the output, in my case these were /dev/sda, /dev/sdb, /dev/sdc&nbsp; (there should also have been /dev/sdd – but that was the dead one):      <p>&nbsp;&nbsp; <font face="Courier New">Device Boot&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Blocks&nbsp;&nbsp; Id&nbsp; System          <br>/dev/sdc1&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 66&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 530113+&nbsp; 83&nbsp; Linux           <br>/dev/sdc2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 132&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 530145&nbsp;&nbsp; 82&nbsp; Linux swap / Solaris           <br>/dev/sdc3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 133&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 243138&nbsp; 1951945695&nbsp;&nbsp; 83&nbsp; Linux           <br>/dev/sdc4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 243139&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 243200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 498015&nbsp;&nbsp; 83&nbsp; Linux           <br></font></p>   </li>    <li>Now to replicate this config to the new drive (/dev/sdd).&nbsp; My commands are in <strong><em>bold italics</em></strong>:       <p>       <br><font face="Courier New">[~] # <strong><em>fdisk /dev/sdd              <br></em></strong>Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel           <br>Building a new DOS disklabel. Changes will remain in memory only,           <br>until you decide to write them. After that, of course, the previous           <br>content won't be recoverable.</font></p>      <p>       <br><font face="Courier New">The number of cylinders for this disk is set to 243201.          <br>There is nothing wrong with that, but this is larger than 1024,           <br>and could in certain setups cause problems with:           <br>1) software that runs at boot time (e.g., old versions of LILO)           <br>2) booting and partitioning software from other OSs           <br>&nbsp;&nbsp; (e.g., DOS FDISK, OS/2 FDISK)           <br>Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</font></p>      <p><font face="Courier New">Command (m for help): <strong><em>n              <br></em></strong>Command action           <br>&nbsp;&nbsp; e&nbsp;&nbsp; extended           <br>&nbsp;&nbsp; p&nbsp;&nbsp; primary partition (1-4)           <br><strong><em>p              <br></em></strong>Partition number (1-4): <strong><em>1              <br></em></strong>First cylinder (1-243201, default 1):<em><strong>1</strong>             <br></em>Using default value 1           <br>Last cylinder or +size or +sizeM or +sizeK (1-243201, default 243201): <strong><em>66</em></strong></font></p>      <p><font face="Courier New">Command (m for help): <strong><em>n              <br></em></strong>Command action           <br>&nbsp;&nbsp; e&nbsp;&nbsp; extended           <br>&nbsp;&nbsp; p&nbsp;&nbsp; primary partition (1-4)           <br><strong><em>p              <br></em></strong>Partition number (1-4): <strong><em>2              <br></em></strong>First cylinder (67-243201, default 67):<strong><em>67              <br></em></strong>Using default value 67           <br>Last cylinder or +size or +sizeM or +sizeK (67-243201, default 243201): <strong><em>132</em></strong></font></p>      <p><font face="Courier New">Command (m for help): <strong><em>n              <br></em></strong>Command action           <br>&nbsp;&nbsp; e&nbsp;&nbsp; extended           <br>&nbsp;&nbsp; p&nbsp;&nbsp; primary partition (1-4)           <br><strong><em>p              <br></em></strong>Partition number (1-4): <strong><em>3              <br></em></strong>First cylinder (133-243201, default 133):<strong><em>133</em></strong>           <br>Using default value 133           <br>Last cylinder or +size or +sizeM or +sizeK (133-243201, default 243201): <strong><em>243138</em></strong></font></p>      <p><font face="Courier New">Command (m for help): n          <br>Command action           <br>&nbsp;&nbsp; e&nbsp;&nbsp; extended           <br>&nbsp;&nbsp; p&nbsp;&nbsp; primary partition (1-4)           <br><strong><em>p</em></strong>           <br>Selected partition <strong><em>4              <br></em></strong>First cylinder (243139-243201, default 243139):<strong><em>243139</em></strong>           <br>Using default value 243139           <br>Last cylinder or +size or +sizeM or +sizeK (243139-243201, default 243201): <strong><em>243200</em></strong></font><font face="Courier New"></font></p>   </li>    <li>Next to mark /dev/sdd1 as bootable <font face="Courier New">Command (m for help): <strong><em>a</em></strong>         <br>Partition number (1-4): <strong><em>1</em></strong></font>       <br></li>    <li>Then change partition 2 to ‘Linux Swap / Solaris’ format <font face="Courier New">Command (m for help): <strong><em>t            <br></em></strong>Partition number (1-4): <strong><em>2</em></strong>         <br>Hex code (type L to list codes): <strong><em>82</em></strong>         <br>Changed system type of partition 2 to 82 (Linux swap / Solaris)</font> </li>    <li>Finally, save the new partition table <font face="Courier New">Command (m for help): <strong><em>w            <br></em></strong>The partition table has been altered!         <br></font></li>    <li>Ctrl-C to exit fdisk </li>    <li>Eject the new disk and reinsert </li>    <li>The new disk is recognised and rebuilding begins </li>    <li>Wait for rebuild to complete </li>    <li>PROFIT!! </li> </ol>  <p>I’m aware that on a full linux distribution there are better approaches than this, but on the QNAP with it’s subset of commands this gets the job done reasonably well.</p>  